name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        type: environment
        required: true

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v3
      id: artifact
      with:
        name: 'last-commit'
        path: artifact.txt

    - name: 'Echo download path'
      run: |
        echo ${{steps.artifact.outputs.download-path}}
        cat ${{steps.artifact.outputs.download-path}}/artifact.txt 
        LAST_TAG=`cat ${{steps.artifact.outputs.download-path}}/artifact.txt `
        echo $LAST_TAG >> $GITHUB_ENV

    - name: Debug output
      run: echo "last tag is $LAST_TAG"

    # - uses: actions/checkout@v3
    - name: Fetch release version
      run: |
        DOCKER_TAG=`date '+%Y%m%d_%H'`
        DOCKERHUB_IMAGENAME="yakumosaki/glitch-soc"
        cat $DOCKER_TAG > ${{steps.artifact.outputs.download-path}}/artifact.txt
        echo $DOCKER_TAG

    - uses: actions/upload-artifact@v3
      with:
        name: 'last-commit'
        path: ${{steps.artifact.outputs.download-path}}/artifact.txt
